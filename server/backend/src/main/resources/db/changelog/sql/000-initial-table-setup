CREATE TABLE ROLES(
    role_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY ,
    role_name VARCHAR(128) UNIQUE NOT NULL,
    PRIMARY KEY (role_id)
);

INSERT INTO ROLES(role_name)
VALUES ('BASIC_USER');

INSERT INTO ROLES(role_name)
VALUES ('ADMIN');

CREATE TABLE USER_TABLE(
    user_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    user_email VARCHAR(128) UNIQUE NOT NULL,
    user_name VARCHAR(64) UNIQUE NOT NULL,
    user_timezone VARCHAR,
    user_broker_link BOOLEAN NOT NULL DEFAULT FALSE,
    pass_hash VARCHAR NOT NULL,
    role_id BIGINT NOT NULL,
    FOREIGN KEY (role_id) REFERENCES ROLES(role_id),
    PRIMARY KEY (user_id)
);

CREATE TABLE DEVICE (
    device_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    device_name VARCHAR(64) NOT NULL,
    device_owner BIGINT NOT NULL,
    FOREIGN KEY (device_owner) REFERENCES USER_TABLE(user_id),
    PRIMARY KEY (device_id),
    CONSTRAINT device_unique_constraint UNIQUE (device_name, device_owner)
);

CREATE TABLE TOPIC_DATA (
    topic_data_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    topic_data_desc VARCHAR(512),
    PRIMARY KEY (topic_data_id)
);

CREATE TABLE TOPIC_DIR (
    topic_dir_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    topic_dir_desc VARCHAR(512),
    PRIMARY KEY (topic_dir_id)
);

CREATE TABLE TOPIC (
    topic_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    topic_name VARCHAR(64) NOT NULL,
    device_id BIGINT NOT NULL,
    topic_dir_id BIGINT NOT NULL,
    topic_data_id BIGINT NOT NULL,
    FOREIGN KEY (device_id) REFERENCES DEVICE(device_id),
    FOREIGN KEY (topic_dir_id) REFERENCES TOPIC_DIR(topic_dir_id),
    FOREIGN KEY (topic_data_id) REFERENCES TOPIC_DATA(topic_data_id),
    PRIMARY KEY (topic_id),
    CONSTRAINT topic_unique_constraint UNIQUE (topic_name, device_id)
);

CREATE TABLE READINGS (
    reading_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY ,
    reading_value VARCHAR(128) NOT NULL ,
    topic_id BIGINT NOT NULL ,
    reading_timestamp TIMESTAMP NOT NULL ,
    FOREIGN KEY (topic_id) REFERENCES TOPIC(topic_id),
    PRIMARY KEY (reading_id)
);

CREATE TABLE CONNECTIONS (
    conn_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY ,
    conn_mqtt_id VARCHAR(128) NOT NULL UNIQUE ,
    conn_name VARCHAR(64) NOT NULL ,
    user_id BIGINT NOT NULL ,
    FOREIGN KEY (user_id) REFERENCES USER_TABLE(user_id),
    PRIMARY KEY (conn_id)
);

/*TOPIC DATA ID 0*/
INSERT INTO TOPIC_DATA(topic_data_id, topic_data_desc)
VALUES (0, 'Max. 128 bytes, no specific data type.');

/*TOPIC DATA ID 1*/
INSERT INTO TOPIC_DATA(topic_data_id, topic_data_desc)
VALUES (1, '5 byte temperature value. Textual representation of the temperature in range [-99.9, 99.99].');

/*TOPIC DATA ID 2*/
INSERT INTO TOPIC_DATA(topic_data_id, topic_data_desc)
VALUES (2, 'Boolean. 1 byte(0 -> false, 1-255 -> true)');

/*TOPIC DATA ID 3*/
INSERT INTO TOPIC_DATA(topic_data_id, topic_data_desc)
VALUES (3, 'uint8_t. 1-255');

/*TOPIC DIR ID 0*/
INSERT INTO TOPIC_DIR(topic_dir_id, topic_dir_desc)
VALUES (0, 'Basic publish.');

/*TOPIC DIR ID 1*/
INSERT INTO TOPIC_DIR(topic_dir_id, topic_dir_desc)
VALUES (1, 'Basic subscribe.');

/*TOPIC DIR ID 2*/
INSERT INTO TOPIC_DIR(topic_dir_id, topic_dir_desc)
VALUES (2, 'Base topic for publishing other resources from device. At least one subtopic will be present following this topic.');

/*TOPIC DIR ID 3*/
INSERT INTO TOPIC_DIR(topic_dir_id, topic_dir_desc)
VALUES (3, 'Subscribe topic for receiving data that are forwarded to other devices. On this topic the subscribe(<TOPIC>/#) is performed.');